name: Makefile

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: release
  # cancel-in-progress: true

jobs:
  ga-test:
    runs-on: ubuntu-latest
    env:
      CRYPTOMEDIC_PROD: true

    steps:
    - name: Setup Node.js environment
      uses: actions/setup-node@v3.2.0
      with:
        node-version: current
    - uses: actions/checkout@v3

    - name: Build docker images
      run: docker build -t local .

    - name: start docker
      run: docker run --name devcontainer --detach --privileged --volume $PWD:/workspaces/cryptomedic --workdir /workspaces/cryptomedic local sleep infinity

    - name: make dump
      run: docker exec devcontainer make dump

    - name: make dependencies
      run: docker exec devcontainer make dependencies

    - name: make build
      run: docker exec devcontainer make build

    - name: make test-api
      run: docker exec devcontainer make test-api

    - name: make test-unit
      run: docker exec devcontainer make test-unit

    # TODO
    - name: make test-e2e-desktop
      run: docker exec devcontainer make test-e2e-desktop

    # TODO
    - name: make test-e2e-mobile
      run: docker exec devcontainer make test-e2e-mobile

    # TODO
    - name: make test-styles
      run: docker exec devcontainer make test-styles

    # TODO
    - name: 'Artifacts test-styles'
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: styles
        path: tmp/styles/
        retention-days: 1

    - name: make lint
      run: docker exec devcontainer make lint

    # TODO
    - name: make deploy
      run: docker exec devcontainer make deploy
      if: ${{ github.ref_name == 'main' && github.ref_type == 'branch' }}
      env:
        CRYPTOMEDIC_DB_UPGRADE: ${{ secrets.CRYPTOMEDIC_DB_UPGRADE }}
        CRYPTOMEDIC_UPLOAD_PASSWORD: ${{ secrets.CRYPTOMEDIC_UPLOAD_PASSWORD }}
        CRYPTOMEDIC_UPLOAD_USER: ${{ secrets.CRYPTOMEDIC_UPLOAD_USER }}

    - name: stop docker
      run: docker kill devcontainer
