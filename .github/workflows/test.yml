name: Makefile

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: release
  # cancel-in-progress: true

jobs:
  ga-test:
    runs-on: ubuntu-latest
    env:
      CRYPTOMEDIC_PROD: true

    steps:
    - name: Setup Node.js environment
      uses: actions/setup-node@v3.2.0
      with:
        node-version: current
    - uses: actions/checkout@v3

    - name: dc dump
      uses: jehon/actions-devcontainer@main
      with:
        action: dump
        dc-user: user

    - id: start
      name: dc start
      uses: jehon/actions-devcontainer@main
      with:
        action: start
        dc-user: user

    - name: make dump
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: dump
        dc-user: user

    - name: make dependencies
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: dependencies
        dc-user: user

    - name: make build
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: build
        dc-user: user

    - name: make test-api
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-api
        dc-user: user

    - name: make test-api-bare
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-api-bare
        dc-user: user

    - name: make test-unit
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-unit
        dc-user: user

    - name: make test-e2e-desktop
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-e2e-desktop
        dc-user: user

    - name: make test-e2e-mobile
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-e2e-mobile
        dc-user: user

    - name: make test-styles
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-styles
        dc-user: user

    - name: make lint
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: lint
        dc-user: user

    # # TODO
    # - name: make deploy
    #   run: docker exec devcontainer make deploy
    #   if: ${{ github.ref_name == 'main' && github.ref_type == 'branch' }}
    #   env:
    #     CRYPTOMEDIC_DB_UPGRADE: ${{ secrets.CRYPTOMEDIC_DB_UPGRADE }}
    #     CRYPTOMEDIC_UPLOAD_PASSWORD: ${{ secrets.CRYPTOMEDIC_UPLOAD_PASSWORD }}
    #     CRYPTOMEDIC_UPLOAD_USER: ${{ secrets.CRYPTOMEDIC_UPLOAD_USER }}

    - name: make release
      if: ${{ github.ref == 'refs/heads/main' }}
      run: docker exec -e "JH_DOCKER_HUB_TOKEN=${{ secrets.JH_DOCKER_HUB_TOKEN }}" ${{ steps.start.outputs.container }} make --debug release

    - name: stop docker
      run: docker kill devcontainer

    - name: 'Artifacts test-styles'
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: styles
        path: tmp/styles/
        retention-days: 1
