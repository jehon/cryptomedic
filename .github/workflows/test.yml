name: Makefile

on:
  push:
    branches:
    - main
    - ci/*
  pull_request:
    branches:
    - main
  workflow_dispatch:

jobs:
  ga-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - uses: actions/checkout@v3

    - name: swap
      run: |
        sudo fallocate -l 2G /swap
        sudo chmod 400 /swap
        sudo mkswap /swap
        sudo swapon /swap

    - name: dc dump
      uses: jehon/actions-devcontainer@main
      with:
        action: dump

    - id: start
      name: dc start
      uses: jehon/actions-devcontainer@main
      with:
        action: start
        dc-env-0: CRYPTOMEDIC_PROD=true

    - name: make dump
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: dump

    - name: make dependencies
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: dependencies

    - name: make build
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: build

    - name: make test-api
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-api

    - name: make test-api-bare
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-api-bare

    - name: make test-unit
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-unit

    - name: make test-e2e-desktop
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-e2e-desktop

    - name: make test-e2e-mobile
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-e2e-mobile

    - name: make test-styles
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: test-styles

    - name: make lint
      uses: jehon/actions-devcontainer@main
      with:
        action: make
        make: lint

    # # TODO
    # - name: make deploy
    #   run: docker exec devcontainer make deploy
    #   if: ${{ github.ref_name == 'main' && github.ref_type == 'branch' }}
    #    concurrency:
    #      group: 'release'
    #   env:
    #     CRYPTOMEDIC_DB_UPGRADE: ${{ secrets.CRYPTOMEDIC_DB_UPGRADE }}
    #     CRYPTOMEDIC_UPLOAD_PASSWORD: ${{ secrets.CRYPTOMEDIC_UPLOAD_PASSWORD }}
    #     CRYPTOMEDIC_UPLOAD_USER: ${{ secrets.CRYPTOMEDIC_UPLOAD_USER }}

    # - name: make release
    #    concurrency:
    #      group: 'release'
    #   if: ${{ github.ref == 'refs/heads/main' }}
    #   run: docker exec -e "JH_DOCKER_HUB_TOKEN=${{ secrets.JH_DOCKER_HUB_TOKEN }}" ${{ steps.start.outputs.container }} make --debug release

    # This will upload the docker.log
    - name: stop docker
      if: always()
      uses: jehon/actions-devcontainer@main
      with:
        action: stop

    - name: 'Artifacts test-styles'
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: styles
        path: tmp/styles/
