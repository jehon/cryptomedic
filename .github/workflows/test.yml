name: Makefile

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ga-test:
    runs-on: ubuntu-latest
    env:
      CRYPTOMEDIC_PROD: true

    steps:
    - name: Setup Node.js environment
      uses: actions/setup-node@v3.2.0
      with:
        node-version: 16
    - uses: actions/checkout@v3
    - run: make computer-setup
    - run: make dump
    - run: make start
    - run: make dump-dockers
    - run: make dependencies
    - run: make build
    - run: make test-api
    - run: make test-unit
    - run: make test-e2e-desktop
    - run: make test-e2e-mobile
    - run: make test-styles
    - name: 'Artifacts test-styles'
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: styles
        path: tmp/styles/
        retention-days: 1
    - run: make lint
    - run: make deploy
      if: ${{ github.ref_name == 'main' && github.ref_type == 'branch' }}
      env:
        CRYPTOMEDIC_DB_UPGRADE: ${{ secrets.CRYPTOMEDIC_DB_UPGRADE }}
        CRYPTOMEDIC_UPLOAD_PASSWORD: ${{ secrets.CRYPTOMEDIC_UPLOAD_PASSWORD }}
        CRYPTOMEDIC_UPLOAD_USER: ${{ secrets.CRYPTOMEDIC_UPLOAD_USER }}
