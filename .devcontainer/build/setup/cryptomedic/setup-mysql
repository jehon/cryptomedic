#!/usr/bin/env bash

set -o errexit

# shellcheck source=/usr/bin/jh-lib
. jh-lib

VERSION="$1"
if [ -z "$VERSION" ]; then
    jh_fatal "Specify version as [1]"
fi

export DEBIAN_FRONTEND=noninteractive

#
# See https://stackoverflow.com/a/34806229/1954789
#

NAME="$( lsb_release -si )"
NAME="${NAME,,}"
RELEASE="$( lsb_release -sc )"

NAME="ubuntu"
RELEASE="precise"

echo "NAME:    $NAME"
echo "RELEASE: $RELEASE"

cat <<-EOS > /etc/apt/sources.list.d/jh-mysql.list
    deb [trusted=yes] http://repo.mysql.com/apt/$NAME/ $RELEASE mysql-apt-config
EOS

apt update --quiet --yes
apt install --quiet --yes "mysql-community-server"

#
# https://dev.mysql.com/doc/refman/8.0/en/data-directory-initialization.html
#
header_begin "Initialize mysql"
/usr/sbin/mysqld --initialize-insecure --user=mysql --defaults-file=/etc/mysql/my.cnf 2>&1 | tee /setup/log/mysql-initialize.log || true
header_end
