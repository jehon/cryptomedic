<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<dom-module name="my-busy">
  <template>
    <paper-dialog
          modal
          entry-animation="scale-up-animation"
          exit-animation="fade-out-animation"
          position-target="body"
          >
      <h2>
        Waiting for: [[todoCount]] tasks to finish.
      </h2>
      <template is="dom-repeat" items="[[elements]]">
        <div class='task'>
          <paper-spinner hidden$="{{item.done}}" active></paper-spinner>
          <iron-icon hidden$="{{!item.done}}" icon="check" ></iron-icon>
          <span style="padding-left: 10px">
            [[item.title]]
          </span>
        </div>
      </template>
    </paper-dialog>
  </template>

  <script>

    (function() {
      Polymer({
        is: 'my-busy',

        // https://www.polymer-project.org/1.0/docs/devguide/properties
        properties: {
          title: {
            type:               String,
            value:              "Busy"
          },
          elements: {
            type:               Array,
            readOnly:           true,
            value:              [ ]
          },
        },

        add: function(title) {
          var i = this.push('elements', { title: title, done: false });
          // this.async(this.redraw);
          this.redraw();
          var self = this;
          return function() {
            self.elements[i].done = true;
            self.redraw();
          }
        },

        redraw: function() {
          this.finishedCount = 0;
          for(var i in this.elements) {
            if (this.elements[i].done) {
              this.finishedCount++;
            }
          }

          if (this.finishedCount == this.elements.length) {
            this.elements = [];
            this.$$('paper-dialog').close();
          } else {
            this.$$('paper-dialog').open();
            this.$$("paper-dialog").fit();
          }
          this.todoCount = this.elements.length - this.finishedCount;
        },

        ready: function() {
          this.redraw();
        }
      });
    })();
  </script>
</dom-module>
