<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/fetchfull-elements/src/fetchfull-element.html">

<dom-module name="cryptomedic-login-status">
  <template>
    <span hidden$=[[!username]]>
      <!-- login status -->
      <span>
        <span id='login_loggedusername'>[[username]]</span>
        <img id='logout' src="resources/logout.gif"/>
      </span>
      <cryptomedic-data-service id='service'></cryptomedic-data-service>
    </span>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'cryptomedic-login-status',

        properties: {},

        listeners: {
          'logout.tap': 'doLogout'
        },

        attached() {
          this.username = false;

          // Let's react to info about the user
          store.subscribe(() => {
            const data = store.getState().user;
            if (data) {
              this.username = data.username;
              if (!window.cryptomedic) {
                window.cryptomedic = {};
              }
              window.cryptomedic.serverSettings = data;

              /* global JHAuthorized */
              JHAuthorized.setAuthorizedList(data.authorized);

              if (location.hash == "#/login") {
                location.hash = "#/home";
              }
            } else {
              this.username = false;
              window.cryptomedic.serverSettings = {};
              location.hash = "/login";

              JHAuthorized.setAuthorizedList();
            }
          });

          // Let's check the login directly
          this.$.service.doLoginCheck();

        },

        doLogout() {
          this.$.service.doLogout();
        }
      })
    })();
  </script>
</dom-module>
