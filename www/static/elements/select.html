<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module name="jh-select">
  <style>
    :host {
      display: block;
    }

    #radio {
      width: 100%;

      display: flex;
      flex-wrap: wrap;
    }

    #radio > span {
      border: 1px solid red;
      display: block;
      width: 50%;
    }

    select {
      width: 100%;
    }
  </style>
  <template>
    value: '[[value]]'-
    <form id='t'>
      <template is='dom-if' if='[[!isSelect(list)]]'>
        <span id='radio'>
          <template is="dom-repeat" items="[[list]]">
            <span on-tap='updateValueFromSpan' to='[[escape(item)]]'>
              <input name='[[id]]' type='radio' on-change='updateValueFromRadio' value$='[[escape(item)]]' >
                <span>[[item]]</span>
              <br>
            </span>
          </template>
          <template is='dom-if' if='[[nullable]]'>
            <span on-tap='updateValueFromSpan' to=''>
              <input name='[[id]]' type='radio' on-change='updateValueFromRadio' null>
              <span>?</span>
            </span>
          </template>
        </span>
      </template>
      <template is='dom-if' if='[[isSelect(list)]]'>
        <select id='select' on-change='updateValueFromSelect'>
          <template is="dom-repeat" items="[[list]]">
            <option name$='[[escape(item)]]' value='[[escape(item)]]'>[[item]]</option>
          </template>
          <template is='dom-if' if='[[nullable]]'>
            <option name$='[[escape(item)]]' value='' null>?</option>
          </template>
        </select>
      </template>
    </form>
  </template>

  <script>
    (function() {
      let internalUUID=1;

      Polymer({
        is: 'jh-select',

        // https://www.polymer-project.org/1.0/docs/devguide/properties
        properties: {
          value: {
            type:               String,
            value:              null,
            notify:             true,
            observer:           'updateValue'
          },
          list: {
            type:               Array,
            value:              [],
          },
          nullable: {
            type:               Boolean,
            value:              false,
            notify:             true
          },
          mode: {
            type:               String,
            value:              "radio",
            notify:             true,
            readOnly:           true,
            reflectToAttribute: true
          }
        },

        ready() {
          this.id = "jh-select-" + (internalUUID + 1);
          this.updateValue();
        },

        listeners: {
          "dom-change": "updateValue"
        },

        observers: [
          // Observer more than one value...
          "updateValue(value, list, nullify)"
        ],

        // Adapt display

        isSelect(list) {
          if (!list) {
            return false;
          }
          return list.length > 6;
        },

        escape(str) {
          if (str == null) {
            return '';
          }
          return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        },

        // Handle value update

        updateValue() {
          // Readonly could only be set like this: https://www.polymer-project.org/1.0/docs/devguide/properties#read-only
          this._setMode(this.isSelect(this.list) ? "select" : "radio");
          if (this.value == '') {
            this.value = null;
            return;
          }

          if (this.value == 'null') {
            this.value = null;
            return;
          }

          Polymer.dom.flush();
          let s = this.$$('select')
          if (s) {
            if (this.value == null) {
              s.value = '';
            } else {
              s.value = this.value;
            }
          }

          let r;
          if (this.value == null) {
            r = this.$$('input[type=radio][null]');
          } else {
            r = this.$$('input[type=radio][value="' + this.escape(this.value) + '"]');
          }
          if (r) {
            r.setAttribute('checked', true);
          }
          Polymer.dom.flush();
        },

        // SELECT
        updateValueFromSelect() {
          this.value = this.$$('select').value;
        },

        // RADIO
        updateValueFromRadio() {
          this.value = this.$$('input[type=radio]:checked').value;
        },

        // RADIO SPAN AROUND
        updateValueFromSpan(event) {
          this.value = event.currentTarget.to;
        },
      });
    })();
  </script>
</dom-module>
