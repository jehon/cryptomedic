<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/fetchfull-elements/src/fetchfull-element.html">

<dom-module name="cryptomedic-data-service">
  <template>
    <fetchfull-element id='network'>
      <content></content>
    </fetchfull-element>
  </template>

  <script type='text/javascript' src='../../bower_components/dexie/dist/dexie.min.js'></script>
  <script type='text/javascript' src='resources/database.js'></script>
  <script>
    /* global API_VERSION, userCb, Folder, Patient, TimedMap */
    /* exported callbacks */
    (function() {
      let db = new Database();
      let syncedFolders = {};
      let patientFolderCache = new TimedMap(15 * 60);

      if (!window.cryptomedic) {
        window.cryptomedic = {};
      }
      if (!window.cryptomedic.serverSettings) {
        window.cryptomedic.serverSettings = {};
      }

      db.clear();

      Polymer({
        is: 'cryptomedic-data-service',

        properties: {},

        ready: function() {
          // Hook in requestToUrl to add the prefix:
          let r = this.$.network.requestToUrl;
          this.$.network.requestToUrl = function(url) {
            return r.call(this, '/api/' + API_VERSION + '/' + url);
          }
        },

        userCb,

        /**************************/
        /*** Start              ***/
        /**************************/

        start: function() {
          return this.$.network
            .reset()
            .requestWithCredentials("include")
            .responseAsJson()
            .onResponseCode(401, () => {
              window.location = "#login";
            })

            // This is done async % then...
            .onSuccess(json => {
              // Check offline data
              let finished = Promise.resolve();

// TODO HERE
              // Put ONLINE data
              if (typeof(json.online) != "undefined") {
                finished = finished.then(() => {
                  return db.triageList(json.online, false);
                })
              }

              // Return final response with original data:
              return finished.then(() => {
                return json;
              });
            });
        },

        /**************************/
        /*** Authentication     ***/
        /**************************/

        doLoginCheck() {
          return this.start()
            .requestWithGet()
            .requestToUrl('auth/settings')
            .onResponseCode(404, () => {
              return false;
            })
            .then(userCb.fire)
            ;
        },

        doLogin(username, password) {
          return this.start()
            .requestWithPost()
            .requestToUrl('auth/mylogin')
            .requestWithData({
              'username': username,
              'password': password
            })
            .then(userCb.fire)
            ;
        },

        doLogout(localOnly = false) {
          let finished = Promise.resolve();

          // localOnly could be the "tap" event, we thus check carefully what we receive
          if (localOnly !== true) {
            finished = finished.then(() => {
              return this.start()
                .requestWithGet()
                .requestToUrl('auth/logout');
            });
          }
          finished.then(() => {
            userCb.fire(null);
          })
          ;
        },

        /**************************/
        /*** Patient            ***/
        /**************************/

        'searchForPatients': function(params) {
          return this.start()
            .requestWithGet()
            .requestWithData(params)
            .requestToUrl('folder')
            .then(function(data) {
              var list = [];
              for(var i in data) {
                list.push(new Patient(data[i]));
              }
              return list;
            })
        },

        'checkReference': function(year, order) {
          return new Promise((resolve, reject) => {
            this.start()
              .requestWithGet()
              .requestToUrl('reference/' + year + '/' + order)
              .onResponseCode(404, () => {
                resolve(false);
              })
              .then(json => {
                let f = new Folder(json.folder);
                patientFolderCache.set(json.id, f);

                resolve(json);
              })
              .catch((error) => {
                reject(error);
                throw error;
              })
          });
        },

        'createReference': function(year, order) {
          return this.start()
            .requestToUrl('reference')
            .requestWithPost()
            .requestWithData({
              'entryyear': year,
              'entryorder': order
            })
            .then(data => {
              return data;
            })
        },

        getFolder(id) {
          let data = patientFolderCache.get(id);
          if (data != null) {
            console.log("using stored folder: ", data);
            return Promise.resolve(data);
          }

          return this.start()
            .requestWithGet()
            .requestToUrl(`folder/Patient/${id}`)
            .then(json => {
              let f = new Folder(json);
              patientFolderCache.set(id, f);
              return f;
            });
        },

        /**************************/
        /*** Patient - File     ***/
        /**************************/

        createOrSaveFile(data) {
          if (data.id) {
            return this.saveFile(data);
          }
          return this.createFile(data);
        },

        createFile(data) {
          return this.start()
            .requestWithPost()
            .requestToUrl('fiche/' + data.getModel())
            .requestWithData(nullify(data))
            .then(function(data) {
              let f = new Folder(data.folder);
              patientFolderCache.set(data.folder.id, f);
              return f;
            });
        },

        saveFile(data) {
          return this.start()
            .requestWithPut()
            .requestToUrl('fiche/' + data.getModel() + '/' + data['id'])
            .requestWithData(nullify(data))
            .then(function(data) {
              let f = new Folder(data.folder);
              patientFolderCache.set(data.folder.id, f);
              return f;
            });
        },

        deleteFile(data) {
          return this.start()
            .requestWithDelete()
            .requestToUrl('fiche/' + data.getModel() + '/' + data['id'])
            .then(function(data) {
              let f = new Folder(data.folder);
              patientFolderCache.set(data.folder.id, f);
            });
        },

        unlockFile(data) {
          return this.start()
            .requestWithGet()
            .requestToUrl('unfreeze/' + data.getModel() + '/' + data['id'])
            .then(function(data) {
              let f = new Folder(data.folder);
              patientFolderCache.set(data.folder.id, f);
              return f;
            });
        },

        /***********************/
        /*** Report          ***/
        /***********************/

        'getReport': function(reportName, data) {
          return this.start()
            .requestWithGet()
            /* global nullify */
            .requestWithData(nullify(data))
            .requestToUrl('reports/' + reportName)
        },

        /***********************/
        /*** User management ***/
        /***********************/

        'usersList': function() {
          return this.start()
            .requestWithGet()
            .requestToUrl('users')
        },

        'userAdd': function(user) {
          return this.start()
            .requestWithPost()
            .requestToUrl('users')
            .requestWithData(user)
        },

        'userDelete': function(id) {
          return this.start()
            .requestWithDelete()
            .requestToUrl('users/' + id)
        },

        'userUpdate': function(user) {
          return this.start()
            .requestWithPut()
            .requestToUrl('users/' + user.id)
            .requestWithData(user)
        },

        'userPassword': function(id, pwd) {
          return this.start()
            .requestWithPost()
            .requestWithData({ password: pwd })
            .requestToUrl('users/password/' + id)
        }
      });

      return {
        userCb
      }
    })();
  </script>
</dom-module>
