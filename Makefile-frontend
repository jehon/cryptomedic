
FRONTEND_ROOT = src
FRONTEND_DEPENDENCIES_MARK = node_modules/.dependencies
FRONTEND_PUBLISHED = www/built
FRONTEND_BUILT_MARK = $(FRONTEND_PUBLISHED)/.built
FRONTEND_BUILD_TMP = legacy/built

frontend: clear clean-files dc-build dc-up frontend-dump frontend-dependencies frontend-lint frontend-build frontend-test ok

# Temporary
dev-ng: clear frontend-test-ng frontend-lint ok

.PHONY: frontend-clean
clean: frontend-clean
frontend-clean: frontend-clean-files
	rm -fr "$(ROOT)/node_modules"
	rm -fr "$(ROOT)/$(FRONTEND_DEPENDENCIES_MARK)"

	@echo "!! Removed dependencies, so husky (commit) will not work anymore. Please make dependencies-node to enable it again"

.PHONY: frontend-clean-files
clean-files: frontend-clean-files
frontend-clean-files:
	rm -fr "$(ROOT)/$(TMP)/frontend"
	rm -fr "$(ROOT)/$(TMP)/frontend-ng"

	rm -f "$(ROOT)/www/index.html"
	rm -fr "$(ROOT)/$(FRONTEND_PUBLISHED)"
	rm -fr "$(ROOT)/$(FRONTEND_BUILD_TMP)"

	rm -fr "$(FRONTEND_BUILT_MARK)"

.PHONY: frontend-dump
dump: frontend-dump
frontend-dump:
	@echo ""
	@echo "****************"
	@echo "*** Frontend ***"
	@echo ""
	@echo "FRONTEND_ROOT:                  $(FRONTEND_ROOT)"
	@echo "FRONTEND_DEPENDENCIES_MARK:     $(FRONTEND_DEPENDENCIES_MARK)"
	@echo "FRONTEND_PUBLISHED:             $(FRONTEND_PUBLISHED)"
	@echo "FRONTEND_BUILT_MARK:            $(FRONTEND_BUILT_MARK)"
	@echo "FRONTEND_BUILD_TMP:             $(FRONTEND_BUILD_TMP)"
	@echo "NodeJS:                         $(shell node --version 2>&1 )"
	@echo "NPM:                            $(shell npm --version 2>&1 )"

.PHONY: frontend-dependencies
dependencies: frontend-dependencies
frontend-dependencies: $(FRONTEND_DEPENDENCIES_MARK)
$(FRONTEND_DEPENDENCIES_MARK): package-lock.json
	npm ci

	@mkdir -p "$(dir $@)"
	@touch "$@"

package-lock.json: package.json
	npm install --package-lock-only
	@touch "$@"

.PHONY: frontend-lint
lint: frontend-lint
frontend-lint: frontend-lint-es frontend-lint-css frontend-lint-html
	node_modules/.bin/prettier --check .

.PHONY: frontend-lint-es
frontend-lint-es: $(FRONTEND_DEPENDENCIES_MARK)
	node_modules/.bin/eslint --ext .js,.ts,.tsx .

.PHONY: frontend-lint-css
frontend-lint-css: $(FRONTEND_DEPENDENCIES_MARK)
	node_modules/.bin/stylelint src/**/*.css legacy/**/*.css

.PHONY: frontend-lint-html
frontend-lint-html: $(FRONTEND_DEPENDENCIES_MARK)
	node_modules/.bin/htmlhint src/**/*.html legacy/**/*.html tests/**/*.html --format=compact

.PHONY: frontend-build
build: frontend-build
frontend-build: $(FRONTEND_BUILT_MARK)
# We need to depend on axios-mock-adapter.js, because otherwise, this will force a rebuild due to the recursive dependencies
$(FRONTEND_BUILT_MARK): \
		$(FRONTEND_PUBLISHED)/frontend/ng1x.html \
		$(FRONTEND_PUBLISHED)/frontend-ng/index.html \
		$(FRONTEND_PUBLISHED)/.htaccess

	@mkdir -p "$(dir $@)"
	@touch "$@"

$(FRONTEND_PUBLISHED)/frontend/ng1x.html: \
		$(FRONTEND_DEPENDENCIES_MARK) \
		$(shell find legacy/app-old/ ) \
		$(shell find legacy/app-static/ ) \
		$(FRONTEND_BUILD_TMP)/axios.js \
		$(FRONTEND_BUILD_TMP)/axios-mock-adapter.js \
		$(FRONTEND_BUILD_TMP)/platform.js \
		webpack.config.js \
		tsconfig.json tsconfig.app.json

	@mkdir -p "$(dir $@)"
# TODO: should not be here... (need rework of getHTMLNameOfClass)
	CRYPTOMEDIC_DEV=true node_modules/.bin/webpack
	@touch "$@"

frontend-build-ng: 
	/usr/bin/watch "make $(FRONTEND_PUBLISHED)/frontend-ng/index.html" src/

$(FRONTEND_PUBLISHED)/frontend-ng/index.html: \
		$(FRONTEND_DEPENDENCIES_MARK) \
		tsconfig.json tsconfig.app.json angular.json \
		$(shell find src/ )

	@mkdir -p "$(dir $@)"
	node_modules/.bin/ng build
	@touch "$@"

dev: frontend-dev
.PHONY: frontend-dev
frontend-dev: \
		$(FRONTEND_PUBLISHED)/frontend/ng1x.html \
		$(FRONTEND_PUBLISHED)/.htaccess

	@mkdir -p "$(dir $@)"
# node_modules/.bin/ng serve
	node_modules/.bin/ng build --watch --configuration development
	@touch "$@"

$(FRONTEND_PUBLISHED)/.htaccess: src/build.htaccess
	@mkdir -p "$(dir $@)"
	cp "$<" "$@"
	@touch "$@"

# Dependencies are used in the build !
$(FRONTEND_BUILD_TMP)/axios.js: node_modules/axios/dist/axios.js $(FRONTEND_DEPENDENCIES_MARK)
	node_modules/.bin/babel --out-file="$@" --plugins=transform-commonjs "$<"

# Dependencies are used in the build !
$(FRONTEND_BUILD_TMP)/axios-mock-adapter.js: node_modules/axios-mock-adapter/dist/axios-mock-adapter.js $(FRONTEND_DEPENDENCIES_MARK)
	node_modules/.bin/babel --out-file="$@" --plugins=transform-commonjs "$<"
	sed -i 's/from "axios";/from ".\/axios.js";/' $@

# Dependencies are used in the build !
$(FRONTEND_BUILD_TMP)/platform.js: node_modules/platform/platform.js $(FRONTEND_DEPENDENCIES_MARK)
	node_modules/.bin/babel --out-file="$@" --plugins=transform-commonjs "$<"

.PHONY: frontend-test
test: frontend-test
frontend-test: \
		frontend-test-ng \
		frontend-test-legacy
		
.PHONY: frontend-test-legacy
frontend-test-legacy:
	node_modules/.bin/jest

.PHONY: frontend-test-ng
frontend-test-ng: $(FRONTEND_DEPENDENCIES_MARK)
	node_modules/.bin/ng test --no-watch --no-progress --browsers ChromeHeadless

.PHONY: frontend-update-references
update: frontend-update-references
frontend-update-references: $(FRONTEND_BUILT_MARK)


.PHONY: frontend-github
github: frontend-github
frontend-github:
	$(call rehydrate,$(FRONTEND_DEPENDENCIES_MARK),package-lock.json)

migration-status: clear
	@echo "********** In legacy folders ******************"
	@find src -name "*.js" -exec echo "** To: {}" ";" -exec grep --files-with-matches --recursive --fixed-strings "{}" legacy/ tests/unitjs/ legacy/react/ ";" | jh-tag-stdin "to-js"
	@echo ""

	@echo "********** In src folders ******************"

	@grep --recursive --include "*.js" --fixed-strings "/../legacy/" legacy/react/ | jh-tag-stdin "warn"
	@echo ""

	@grep --files-with-matches --recursive --exclude "*.js" --fixed-strings "/../legacy/" legacy/react/ | jh-tag-stdin "ko:deps"
	@echo ""
