
INTEGRATION_TEST_TMP=$(TMP)/integration
INTEGRATION_BUILT_MARK=$(INTEGRATION_TEST_TMP)/.built

integration: clear clean-files dc-build dc-up integration-dump integration-test ok

.PHONY: integration-dump
dump: integration-dump
integration-dump:
	@echo ""
	@echo "*******************"
	@echo "*** integration ***"
	@echo ""
	@echo "INTEGRATION_TEST_TMP:           $(INTEGRATION_TEST_TMP)"
	@echo "Cypress:                        $(shell QUIET=y bin/cr-cypress version )"

.PHONY: integration-clean
clean: integration-clean
integration-clean: integration-clean-files
	rm -fr $(TMP)/integration

.PHONY: integration-clean-files
clean: integration-clean-files
integration-clean-files:
	rm -fr live/
	jh-kill-by-port 9515 || true
# pkill chromedriver || true

.PHONY: integration-build
build: integration-build
integration-build: $(INTEGRATION_BUILT_MARK)

$(INTEGRATION_BUILT_MARK): \
		$(BACKEND_BUILT_MARK) \
		$(FRONTEND_BUILT_MARK) \
		www/built/browsers.json

www/built/browsers.json: .browserslistrc $(FRONTEND_DEPENDENCIES_MARK)
	@mkdir -p "$(dir $@)"
	bin/cr-node node_modules/.bin/browserslist --json > "$@"
	@touch "$@"

.PHONY: integration-test
test: integration-test
integration-test: integration-test-desktop integration-test-mobile integration-test-styles

.PHONY: integration-test-desktop
integration-test-desktop: $(INTEGRATION_TEST_TMP)/.tested-desktop
$(INTEGRATION_TEST_TMP)/.tested-desktop: \
		$(INTEGRATION_BUILT_MARK) \
		$(shell find tests/cypress/ -name "*.js")

	@mkdir -p "$(dir $@)"
	bin/cr-data-reset
	bin/cr-cypress "desktop" "$(INTEGRATION_TEST_TMP)/runtime/desktop"
	@touch "$@"

.PHONY: integration-test-mobile
integration-test-mobile: $(INTEGRATION_TEST_TMP)/.tested-mobile
$(INTEGRATION_TEST_TMP)/.tested-mobile: \
		$(INTEGRATION_BUILT_MARK) \
		$(shell find tests/cypress/ -name "*.js")

	@mkdir -p "$(dir $@)"
	bin/cr-data-reset
	bin/cr-cypress "mobile" "$(INTEGRATION_TEST_TMP)/runtime/mobile"
	@touch "$@"

cypress-open: $(INTEGRATION_BUILT_MARK)
	./bin/cr-cypress open desktop "$(INTEGRATION_TEST_TMP)/runtime/desktop"

.PHONY: test-styles
integration-test-styles: $(INTEGRATION_TEST_TMP)/styles/styles-problems-list.json

$(INTEGRATION_TEST_TMP)/styles/styles-problems-list.json: \
		$(INTEGRATION_TEST_TMP)/.tested-desktop \
		$(INTEGRATION_TEST_TMP)/.tested-mobile

	bin/cr-node node_modules/.bin/ts-node --esm tests/styles/check-styles.ts \
		--root="$(ROOT)" \
		--references="$(ROOT)/tests/styles/references/" \
		--runtime="$(INTEGRATION_TEST_TMP)/runtime" \
		--target="$(INTEGRATION_TEST_TMP)/styles" \

.PHONY: integration-update-references-styles
update: integration-update-references-styles
integration-update-references-styles: \
		$(INTEGRATION_TEST_TMP)/.tested-desktop \
		$(INTEGRATION_TEST_TMP)/.tested-mobile

	bin/cr-node node_modules/.bin/ts-node --esm tests/styles/check-styles.ts \
		--root="$(ROOT)" \
		--references="$(ROOT)/tests/styles/references/" \
		--runtime="$(INTEGRATION_TEST_TMP)/runtime" \
		--target="$(INTEGRATION_TEST_TMP)/styles" \
		--update
