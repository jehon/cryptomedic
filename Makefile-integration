
INTEGRATION_TEST_TMP=$(TMP)/integration
INTEGRATION_BUILT_MARK=$(INTEGRATION_TEST_TMP)/.built

#
# integration-test-{flavor}-test:
#   - tests/styles/references/{flavor}:         references for screenshots     (flat)
#   - $(INTEGRATION_TEST_TMP)/runtime/{flavor}: screenshot taken during test   (by folders)
#   - $(INTEGRATION_TEST_TMP)/.tested-{flavor}: mark
# 
# integration-test-{flavor}-styles:
#   - $(INTEGRATION_TEST_TMP)/styles/differences/{flavor}
#   - $(INTEGRATION_TEST_TMP)/styles/styles-problems-list.json
#

integration: clear clean-files dc-build dc-up integration-dump integration-test ok

.PHONY: integration-dump
dump: integration-dump
integration-dump:
	@echo ""
	@echo "*******************"
	@echo "*** integration ***"
	@echo ""
	@echo "INTEGRATION_TEST_TMP:           $(INTEGRATION_TEST_TMP)"
# @echo "Cypress:                        $(shell QUIET=y bin/cr-cypress version )"

.PHONY: integration-clean
clean: integration-clean
integration-clean: integration-clean-files
	rm -fr "$(ROOT)/$(TMP)/integration"

.PHONY: integration-clean-files
clean: integration-clean-files
integration-clean-files:
	rm -fr "$(ROOT)/live/"
	jh-kill-by-port 9515 || true
# pkill chromedriver || true

.PHONY: integration-build
build: integration-build
integration-build: $(INTEGRATION_BUILT_MARK)

$(INTEGRATION_BUILT_MARK): \
		$(BACKEND_BUILT_MARK) \
		$(FRONTEND_BUILT_MARK) \
		www/built/browsers.json

	@mkdir -p "$(dir $@)"
	@touch "$@"

www/built/browsers.json: .browserslistrc $(FRONTEND_DEPENDENCIES_MARK)
	@mkdir -p "$(dir $@)"
# pipe will not work with snap
	node_modules/.bin/browserslist --json | tee "$@"
	@touch "$@"

.PHONY: integration-test
test: integration-test
integration-test: integration-test-desktop integration-test-mobile integration-test-styles

.PHONY: integration-test-desktop
integration-test-desktop: integration-test-desktop-run integration-test-desktop-style

.PHONY: integration-test-desktop-test
integration-test-desktop-run: $(INTEGRATION_TEST_TMP)/.tested-desktop
$(INTEGRATION_TEST_TMP)/.tested-desktop: \
		$(INTEGRATION_BUILT_MARK) \
		$(shell find tests/cypress/ -name "*.js")

	@mkdir -p "$(dir $@)"
	bin/cr-data-reset
	bin/cr-cypress "desktop" "$(INTEGRATION_TEST_TMP)/runtime/desktop"
	@touch "$@"

.PHONY: integration-test-desktop-style
integration-test-desktop-style: $(INTEGRATION_TEST_TMP)/.tested-desktop
	@true

.PHONY: integration-test-mobile
integration-test-mobile: integration-test-mobile-run integration-test-mobile-style

.PHONY: integration-test-mobile-run
integration-test-mobile-run: $(INTEGRATION_TEST_TMP)/.tested-mobile
$(INTEGRATION_TEST_TMP)/.tested-mobile: \
		$(INTEGRATION_BUILT_MARK) \
		$(shell find tests/cypress/ -name "*.js")

	@mkdir -p "$(dir $@)"
	bin/cr-data-reset
	bin/cr-cypress "mobile" "$(INTEGRATION_TEST_TMP)/runtime/mobile"
	@touch "$@"

.PHONY: integration-test-mobile-style
integration-test-mobile-style: $(INTEGRATION_TEST_TMP)/.tested-mobile
	@true

integration-test-open: $(INTEGRATION_BUILT_MARK)
	./bin/cr-cypress open "$(INTEGRATION_TEST_TMP)/runtime/desktop"

.PHONY: test-styles
integration-test-styles: $(INTEGRATION_TEST_TMP)/styles/styles-problems-list.json

$(INTEGRATION_TEST_TMP)/styles/styles-problems-list.json: \
		$(INTEGRATION_TEST_TMP)/.tested-desktop \
		$(INTEGRATION_TEST_TMP)/.tested-mobile

	node_modules/.bin/tsx tests/styles/check-styles.ts \
		--references="tests/styles/references/" \
		--results="$(INTEGRATION_TEST_TMP)/" \
		--runtime="$(INTEGRATION_TEST_TMP)/runtime" \
		--target="$(INTEGRATION_TEST_TMP)/styles" \

	touch "$@"

.PHONY: integration-update-references-styles
update: integration-update-references-styles
integration-update-references-styles: \
		$(INTEGRATION_TEST_TMP)/styles/styles-problems-list.json \
		integration-update-references-styles-calcul

# Raw without calculs
.PHONY: integration-update-references-styles-calcul
integration-update-references-styles-calcul:
	node_modules/.bin/tsx tests/styles/check-styles.ts \
		--references="tests/styles/references/" \
		--results="$(INTEGRATION_TEST_TMP)/" \
		--runtime="$(INTEGRATION_TEST_TMP)/runtime" \
		--target="$(INTEGRATION_TEST_TMP)/styles" \
		--update
