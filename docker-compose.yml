version: "3.4"

# Also update .ovhconfig
x-common-env:
  &common-env
  PHP_VERSION: &PHP_VERSION "8.0" # OVH is in 8.1
  MYSQL_IMAGE: &MYSQL_IMAGE mysql:5.6
  MYSQL_HOST: &MYSQL_HOST mysql

services:
  server:
    build:
      context: conf/server/
      dockerfile: Dockerfile
      args:
        PHP_VERSION: *PHP_VERSION
    environment:
      IN_DOCKER: server
    expose:
      - 80
    volumes:
      - .:/app

  mysql:
    # https://hub.docker.com/_/mysql/
    image: *MYSQL_IMAGE
    environment:
      IN_DOCKER: mysql
      MYSQL_DATABASE: cryptomedic
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: username
      MYSQL_PASSWORD: password
    expose:
      - 3306

  phpmyadmin:
    # https://hub.docker.com/r/phpmyadmin/phpmyadmin/
    image: phpmyadmin/phpmyadmin
    environment:
      IN_DOCKER: phpmyadmin
      PMA_HOST: *MYSQL_HOST
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: root
    expose:
      - 80
    depends_on:
      - mysql

  mail:
    # https://hub.docker.com/r/mailhog/mailhog/
    # The WS does not work correctly, due to proxy...
    image: mailhog/mailhog
    environment:
      IN_DOCKER: mail
      MH_UI_WEB_PATH: /xmailx
    expose:
      - 1025
      - 8025

  dev:
    build:
      context: conf/dev
      dockerfile: Dockerfile
    environment:
      IN_DOCKER: dev
      <<: *common-env
    volumes:
      - .:/app
    ports:
      - ${CRYPTOMEDIC_PORT:-0}:80 # Only if the variable is not set in the environment

  php:
    profiles: [ "manual" ]
    # See https://hub.docker.com/_/php
    build:
      context: conf/php
      dockerfile: Dockerfile
      args:
        PHP_VERSION: *PHP_VERSION
    environment:
      IN_DOCKER: dev
      <<: *common-env
    working_dir: /app
    volumes:
      - .:/app

  cypress:
    profiles: [ "manual" ]
    # Adaptations:
    # See https://github.com/cypress-io/cypress-docker-images/blob/master/included/7.1.0/Dockerfile
    image: cypress/included:9.3.1 # 8.7.0 is causing issue in github actions: https://stackoverflow.com/a/70519386/1954789
    environment:
      LANG: C.UTF-8
      ENV DBUS_SESSION_BUS_ADDRESS:
      CYPRESS_BASE_URL: http://server
    working_dir: /app
    volumes:
      - .:/app
