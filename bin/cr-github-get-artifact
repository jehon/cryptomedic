#!/usr/bin/bash

set -o errexit
set -o pipefail

. "$(realpath "$(dirname "${BASH_SOURCE[0]}")")"/cr-lib

# We replace the local integration (e2e test results)
# by those of github
TMP_GH="$CR_TMP/integration"
echo "TMP_GH: $TMP_GH"

rm -fr "$TMP_GH"
mkdir -p "$TMP_GH"
cd "$TMP_GH"

# URL="$(
#         curl -fsSl https://api.github.com/repos/${OWNER}/${REPO}/actions/runs/${RUN_ID}/artifacts \
#             | jq -r '.artifacts[] | select(.name == "integration") | .archive_download_url '
#     )"

# echo "URL: $URL"

# curl -fsSl "$URL" > tmp/integration.zip

header_begin "Getting the archive from Github"
# https://cli.github.com/manual/gh_run_list
# gh run list --branch main --limit 1 --workflow .github/workflows/test.yml
RUN_ID="$( gh run list --branch main --limit 1 --workflow .github/workflows/test.yml --json databaseId --jq ".[0].databaseId" )"

echo "RUN_ID: $RUN_ID"
# https://cli.github.com/manual/gh_run_download
gh run download "$RUN_ID" --name integration
header_end

header_begin "Copying files locally"

header_end

echo "Done with success"
