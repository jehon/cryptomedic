#!/usr/bin/env bash

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

cr-ensure-started

# Test install of php-xdebug
# php -i | grep xdebug
# apt update && apt install php-xdebug

mkdir -m 777 -p tmp

if [ "$1" == "COMMIT" ]; then
	echo "Setting COMMIT"
	export COMMIT=1
	shift
fi

testOne() {
	local T="$1" # type: laravel/bare
	local V="$2" # www/api/v1.3
	shift
	shift

	case "$T" in
	"laravel")
		FOLDER="$V"
		REPORTS="tmp/php$(basename "$V")"
		;;

	"bare")
		FOLDER="$V/public"
		REPORTS="tmp/php$(basename "$V")-bare"
		;;
	"*")
		echo "Unsupported flavor: $T" >&2
		exit 255
		;;
	esac

	if [ -f "$FOLDER/phpunit.xml" ]; then
		mkdir -p "$REPORTS"
		chmod a+rwx "$REPORTS"

		header_begin "PHPUnit: $T $V starting"

		cr-docker-compose run --rm -T --workdir "/app/$FOLDER" -e XDEBUG_MODE=coverage -e COMMIT="$COMMIT" \
			"php" \
			./vendor/bin/phpunit --coverage-html "/app/$REPORTS" --coverage-xml "/app/$REPORTS" "$@"

		cr-fix-permissions "$REPORTS"
		header_end
	else
		echo "** $T $V: skipping because no phpunit.xml **" >&2
		pwd
	fi
}

# 1: type (laravel/bare)
# 2: version
T="$1"
V="$2"
shift || true # If arg is missing, do not fail...
shift || true # If arg is missing, do not fail...

if [ -n "$T" ]; then
	if [[ -z "$V" ]]; then
		for Vi in www/api/v*; do
			testOne "$T" "$Vi"
		done
	else
		testOne "$T" "$V"
	fi
else
	if [[ -z "$V" ]]; then
		for Vi in www/api/v*; do
			testOne "laravel" "$Vi"
			testOne "bare" "$Vi"
		done
	else
		testOne "laravel" "$V"
		testOne "bare" "$V"
	fi
fi
