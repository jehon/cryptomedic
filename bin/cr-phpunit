#!/usr/bin/env bash

#
# Env variables
#   COMMIT=1
#

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

#
# !! All path are inside the docker !!
#
#

mkdir -m 777 -p "tmp"

FOLDER="www/api/"
REPORTS="tmp/backend/reports/"

mkdir -p "$REPORTS"
chmod a+rwx "$REPORTS"

header_begin "PHPUnit: $T $V starting"

# ( cd "$FOLDER" && ./vendor/bin/phpunit --coverage-html "$REPORTS" --coverage-xml "$REPORTS" "$@" )

docker compose run --rm --quiet-pull -T \
	-e "COMMIT=$COMMIT" \
	-e "XDEBUG_MODE=coverage" \
	--volume "$(pwd):/workdir" \
	--workdir "/workdir/$FOLDER" \
	--user "$(id -u)" \
	web \
	vendor/bin/phpunit --coverage-html "$REPORTS" --coverage-xml "$REPORTS"

header_end
