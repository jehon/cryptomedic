#!/usr/bin/env bash

#
# Env variables
#   COMMIT=1
#

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

#
# !! All path are inside the docker !!
#
#

mkdir -m 777 -p "tmp"

FOLDER="$CR_REL_PATH"
REPORTS="tmp/backend/reports/"

mkdir -p "$REPORTS"
chmod a+rwx "$REPORTS"

header_begin "PHPUnit: $T $V starting"

# ( cd "$FOLDER" && ./vendor/bin/phpunit --coverage-html "$REPORTS" --coverage-xml "$REPORTS" "$@" )

docker compose run "${CR_DOCKER_ARGS_RUN[@]}" \
	-e "COMMIT=$COMMIT" \
	-e "XDEBUG_MODE=coverage" \
	--volume "$CR_PRJ_DIR:/workdir" \
	--workdir "/workdir/$FOLDER" \
	web \
	vendor/bin/phpunit --coverage-html "$REPORTS" --coverage-xml "$REPORTS" "$@"

header_end
