#!/usr/bin/env bash

#
# Env variables
#   COMMIT=1
#

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

mkdir -m 777 -p tmp

testOne() {
	local V="$1" # ${CR_API_VERSION}
	shift
	shift

	FOLDER="$V"
	REPORTS="$CR_TMP/php$(basename "$V")"

	if [ -f "$FOLDER/phpunit.xml" ]; then
		mkdir -p "$REPORTS"
		chmod a+rwx "$REPORTS"

		header_begin "PHPUnit: $T $V starting"

		export COMMIT
		export XDEBUG_MODE="coverage"

		( cd "$FOLDER" && ./vendor/bin/phpunit --coverage-html "$REPORTS" --coverage-xml "$REPORTS" "$@" )

		header_end
	else
		echo "** $T $V: skipping because no phpunit.xml **" >&2
		pwd
	fi
}

# 2: version
V="$1"

if [[ -z "$V" ]]; then
	for Vi in www/api/v*; do
		testOne "$Vi"
	done
else
	testOne "$V"
fi
