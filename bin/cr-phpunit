#!/usr/bin/env bash

#
# Env variables
#   COMMIT=1
#

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

mkdir -m 777 -p tmp

testOne() {
	local T="$1" # type: laravel/bare
	local V="$2" # ${CR_API_VERSION}
	shift
	shift

	case "$T" in
	"laravel")
		FOLDER="$V"
		REPORTS="$CR_TMP/php$(basename "$V")"
		;;

	"bare")
		FOLDER="$V/public"
		REPORTS="$CR_TMP/php$(basename "$V")-bare"
		;;
	"*")
		echo "Unsupported flavor: $T" >&2
		exit 255
		;;
	esac

	if [ -f "$FOLDER/phpunit.xml" ]; then
		mkdir -p "$REPORTS"
		chmod a+rwx "$REPORTS"

		header_begin "PHPUnit: $T $V starting"

		export COMMIT
		export XDEBUG_MODE="coverage"

		( cd "$FOLDER" && ./vendor/bin/phpunit --coverage-html "$REPORTS" --coverage-xml "$REPORTS" "$@" )

		header_end
	else
		echo "** $T $V: skipping because no phpunit.xml **" >&2
		pwd
	fi
}

# 1: type (laravel/bare)
# 2: version
T="$1"
V="$2"

if [ -n "$T" ]; then
	if [[ -z "$V" ]]; then
		for Vi in www/api/v*; do
			testOne "$T" "$Vi"
		done
	else
		testOne "$T" "$V"
	fi
else
	if [[ -z "$V" ]]; then
		for Vi in www/api/v*; do
			testOne "laravel" "$Vi"
			testOne "bare" "$Vi"
		done
	else
		testOne "laravel" "$V"
		testOne "bare" "$V"
	fi
fi
