#!/usr/bin/env bash

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

header_begin "cr-data-reset: reset folder structure"
rsync -a --delete live-for-test/ live/

chmod -R a+rwX "live/"
chmod -R a+rwX "live/storage"
chmod -R a+rwX "live/storage/uploadedPictures"
mkdir -p "www/api/storage/framework/sessions"
chmod a+rwX "www/api/storage/framework/sessions"

cr-ensure-folder-empty "www/api/bootstrap/cache/"
cr-ensure-folder-empty "www/api/storage/framework/cache"
cr-ensure-folder-empty "www/api/storage/framework/cache/data"
cr-ensure-folder-empty "www/api/storage/framework/views"
cr-ensure-folder-empty "www/api/storage/logs/"
cr-ensure-folder-empty "tmp/integration/webTemp"
cr-ensure-folder-empty "live/backups"
# touch www/api/storage/logs/laravel.log

header_end

# Reset database
header_begin "cr-data-reset - Mysql - restoring initial base"

QUIET=yes cr-mysql --database=mysql -e "CREATE SCHEMA IF NOT EXISTS cryptomedic"

for F in conf/database/dev/*.sql; do
    header_begin "File $(basename "$F")"
    QUIET=yes cr-mysql --database=cryptomedic <"$F"
    header_end
done
header_end

header_begin "cr-data-reset: cr-refresh-structure"
cr-refresh-structure "http://localhost:${CRYPTOMEDIC_DEPLOY_HTTP_PORT}/" "secret"
header_end
