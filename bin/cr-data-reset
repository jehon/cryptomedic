#!/usr/bin/env bash

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

cr-ensure-started

header_begin "cr-data-reset: reset folder structure..."
cr-docker-compose run --rm \
    "dev" \
    rsync -a --delete live-for-test/ live/

cr-fix-permissions "live/"
chmod -R a+rwX live/storage/uploadedPictures

cr-ensure-folder-empty "www/api/${CR_API_VERSION}/bootstrap/cache/"
cr-ensure-folder-empty "www/api/${CR_API_VERSION}/storage/framework/cache"
cr-ensure-folder-empty "www/api/${CR_API_VERSION}/storage/framework/cache/data"
cr-ensure-folder-empty "www/api/${CR_API_VERSION}/storage/framework/sessions"
cr-ensure-folder-empty "www/api/${CR_API_VERSION}/storage/framework/views"
cr-ensure-folder-empty "www/api/${CR_API_VERSION}/storage/logs/"
cr-ensure-folder-empty "tmp/webTemp/cache"
# touch www/api/${CR_API_VERSION}/storage/logs/laravel.log
cr-fix-permissions

header_end

# Reset database
header_begin "cr-data-reset - Mysql - waiting for server"
cr-docker-compose exec -T \
    "mysql" \
    bash -c "while ! mysql --user=root --password=root --database=mysql -e 'Show tables;' &>/dev/null; do sleep 1; done"
header_end

header_begin "cr-data-reset - Mysql - configuring"
cr-docker-compose exec -T \
    "mysql" \
    mysql --user=root --password=root --database=mysql -e " \
            USE mysql; \
            DROP SCHEMA IF EXISTS cryptomedic ; \
            CREATE SCHEMA cryptomedic; \
            USE cryptomedic; \
            GRANT ALL PRIVILEGES ON cryptomedic   TO username; \
            GRANT ALL PRIVILEGES ON cryptomedic.* TO username; \
            SET PASSWORD FOR username = PASSWORD('password'); \
        "
# Mysql 5.7, 7.0:
# 	ALTER USER 'root' IDENTIFIED WITH mysql_native_password BY 'password';
# 	ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';
header_end

header_begin "cr-data-reset - Mysql - restoring base.sql"
cr-docker-compose exec -T \
    "mysql" \
    mysql --user=root --password=root --database="cryptomedic" <"conf/database/base.sql"

header_end

header_begin "cr-data-reset: cr-refresh-structure"
cr-refresh-structure
header_end
