#!/usr/bin/env bash

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

header_begin "cr-data-reset: reset folder structure"
rsync -a --delete live-for-test/ live/

chmod -R a+rX "live/"
chmod -R a+rwX live/storage/uploadedPictures

cr-ensure-folder-empty "www/api/bootstrap/cache/"
cr-ensure-folder-empty "www/api/storage/framework/cache"
cr-ensure-folder-empty "www/api/storage/framework/cache/data"
cr-ensure-folder-empty "www/api/storage/framework/sessions"
cr-ensure-folder-empty "www/api/storage/framework/views"
cr-ensure-folder-empty "www/api/storage/logs/"
cr-ensure-folder-empty "tmp/webTemp/cache"
# touch www/api/storage/logs/laravel.log

header_end

# Reset database
header_begin "cr-data-reset - Mysql - configuring"

## The user may already exists
## In mysql 7+, there is an "IF NOT EXISTS"
echo "* Create user"
cr-mysql --database=mysql -e "DROP USER 'mysql_cryptomedic_username'" 2>/dev/null || true
cr-mysql --database=mysql -e "CREATE USER 'mysql_cryptomedic_username' IDENTIFIED BY 'password'; FLUSH PRIVILEGES;"

echo "* Create schema"
cr-mysql --database=mysql -e " \
        USE mysql; \
        DROP SCHEMA IF EXISTS cryptomedic ; \
        CREATE SCHEMA cryptomedic; \
        USE cryptomedic; \
        GRANT ALL PRIVILEGES ON cryptomedic   TO mysql_cryptomedic_username; \
        GRANT ALL PRIVILEGES ON cryptomedic.* TO mysql_cryptomedic_username; \
        SET PASSWORD FOR mysql_cryptomedic_username = PASSWORD('mysql_cryptomedic_password'); 
        FLUSH privileges; \
    "
# Mysql 5.7, 7.0:
# 	ALTER USER 'root' IDENTIFIED WITH mysql_native_password BY 'password';
# 	ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';
header_end

header_begin "cr-data-reset - Mysql - restoring base.sql"
cr-mysql --database=cryptomedic <"conf/database/base.sql"
header_end

header_begin "cr-data-reset: cr-refresh-structure"
cr-refresh-structure
header_end
