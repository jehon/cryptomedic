#!/usr/bin/env bash

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-deploy-lib

ACTION="$1"

REMOTE_LISTING="$CR_TMP"/deploy-remote.txt
# We use this file in lftp_mkdir
truncate --size=0 "$REMOTE_LISTING"

echo ""
header_begin "Updating maintenance scripts [for real]"
(
	while read -r F; do
		ftp_put "$F" "$F"
	done < <(find www/maintenance/ -type f)
	ftp_put deploy-filter
) | ftp_exec
header_end

header_begin "Getting the md5 from local"
cr_curl "Getting the md5 from local" "http://localhost:$CRYPTOMEDIC_LOCAL_HTTP_PORT/maintenance/md5sum.php?filter=local" >"$CR_TMP"/deploy-local.txt
header_end

header_begin "Sorting local file"
sort --stable "$CR_TMP"/deploy-local.txt >"$CR_TMP"/deploy-local.sorted.txt
header_end

header_begin "Getting the md5 from remote"
cr_curl "http://${CRYPTOMEDIC_DEPLOY_WEB_HOST}:${CRYPTOMEDIC_DEPLOY_WEB_PORT}/maintenance/md5sum.php?filter=remote" >"$REMOTE_LISTING"
header_end

header_begin "Sorting remote file"
sort --stable "$REMOTE_LISTING" >"$CR_TMP"/deploy-remote.sorted.txt
header_end

if diff -q "$CR_TMP"/deploy-remote.sorted.txt "$CR_TMP"/deploy-local.sorted.txt; then
	echo "No diff found"
else
	header_begin "Building the diff"
	{
		diff -u "$CR_TMP"/deploy-remote.sorted.txt "$CR_TMP"/deploy-local.sorted.txt || true
	} | tee "$CR_TMP"/deploy-diff-1-raw.txt |
		grep -e "^[+-]" | grep -v "^+++" | grep -v "^---" | tee "$CR_TMP"/deploy-diff-2-filtered.txt |
		cut -c 1,13- | tee "$CR_TMP"/deploy-diff-3-changed.txt |
		LC_ALL=POSIX sort -k1.2 -k1.1r | tee "$CR_TMP"/deploy-diff-4-sorted.txt |
		{
			while read -r lfile; do
				file="${lfile:1}"
				if [ "${lfile:0:1}" == "+" ]; then
					ftp_put "$file"
				else
					ftp_rm "$file"
				fi
			done
		} >"$CR_TMP"/deploy-diff-5-sftp-commands.txt
	header_end

	if [ -r "$CR_TMP"/deploy-diff-4-sorted.txt ]; then
		echo "-------------- Differences --------------"
		echo "-------------- Differences --------------"
		echo "-------------- Differences --------------"
		cat "$CR_TMP"/deploy-diff-4-sorted.txt
		echo "-------------- Differences --------------"
		echo "-------------- Differences --------------"
		echo "-------------- Differences --------------"

		if [ "$ACTION" == "commit" ]; then
			header_begin "Commiting"
			ftp_exec <"$CR_TMP"/deploy-diff-5-sftp-commands.txt
			header_end
		else
			echo "!!!!!!!!!!!!!!!!!!! TEST MODE !!!!!!!!!!!!!!!!!!!!!!"
			echo "!!!!!!!!!!!!!!!!!!! TEST MODE !!!!!!!!!!!!!!!!!!!!!!"
			echo "!!!!!!!!!!!!!!!!!!! TEST MODE !!!!!!!!!!!!!!!!!!!!!!"
			cat "$CR_TMP"/deploy-diff-5-sftp-commands.txt
			echo "!!!!!!!!!!!!!!!!!!! TEST MODE !!!!!!!!!!!!!!!!!!!!!!"
			echo "!!!!!!!!!!!!!!!!!!! TEST MODE !!!!!!!!!!!!!!!!!!!!!!"
			echo "!!!!!!!!!!!!!!!!!!! TEST MODE !!!!!!!!!!!!!!!!!!!!!!"
			echo ""
			echo "To really commit, use:"
			echo "$0 commit"
			echo ""
		fi
	fi
fi

sleep 2

header_begin "Refreshing structure"
"$CR_SCRIPT_DIR/"cr-refresh-structure "http://${CRYPTOMEDIC_DEPLOY_WEB_HOST}:${CRYPTOMEDIC_DEPLOY_WEB_PORT}" "${CRYPTOMEDIC_DEPLOY_WEB_TOKEN}"
header_end

echo "*** End ***"
