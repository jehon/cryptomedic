#!/usr/bin/env bash

set -o errexit
set -o pipefail

#
# Caution:
#
#   this script can be called like: $0 < blabla.sql
#
# So, nobody can listen to stdin before the real "mysql" call!
#

mysql_test() {
    # Do not capture stdin!
    docker compose exec mysql mysql -e "SHOW DATABASES;" > /dev/null < /dev/null
}

sleep 1s
if ! mysql_test ; then
    echo -n "Waiting for mysql"
    sleep 0.5s
    while ! mysql_test ; do
        echo -n "."
        sleep 0.5s
    done
    echo
fi

# -T is necessary for <file.sql
docker compose exec -T mysql mysql "$@"
