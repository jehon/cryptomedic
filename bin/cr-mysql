#!/usr/bin/env bash

set -o errexit
set -o pipefail

. "$(realpath "$(dirname "${BASH_SOURCE[0]}")")"/cr-lib

#
# Caution:
#
#   this script can be called like: $0 < blabla.sql
#
# So, nobody can listen to stdin before the real "mysql" call!
#

. "$(realpath "$(dirname "${BASH_SOURCE[0]}")")"/cr-lib

mysql_run() {
    docker compose exec -T mysql mysql -h localhost "$@"
}

#
# We always wait... that does not take that much time
#
mysql_test() {
    # Do not capture stdin!
    bin/cr-mysqladmin ping -h "localhost" --silent >/dev/null </dev/null
}

while ! mysql_test; do
    sleep 0.5s
done

# -T is necessary for <file.sql
header_begin "Mysql: running $* ..."
mysql_run "$@"
header_end
