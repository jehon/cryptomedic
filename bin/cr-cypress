#!/usr/bin/env bash

#
# Arguments:
#   1: desktop / mobile
#
# Folders:
#   OUTPUT: tmp/e2e/$1
#

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

CYPRESS_ARGS=()

setup_folders() {
    OUTPUT="$1"

    header_begin "Setup $OUTPUT"
    mkdir -p "$OUTPUT"
    cr-ensure-folder-empty "$OUTPUT"/screenshots
    cr-ensure-folder-empty "$OUTPUT"/videos
    cr-ensure-folder-empty "$OUTPUT"/coverage
    header_end
}

run_cypress() {
    header_begin "Cypress run tests ($*)"
    docker compose run --rm --quiet-pull \
        --volume "$(pwd):/workdir" \
        --workdir /workdir/tests \
        --user "$(id -u)" --env HOME=/root \
        -e DISPLAY \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        --entrypoint "cypress" \
        cypress \
        "$@"

    header_end
}

case "$1" in
"version")
    run_cypress "version" "--component" "package"
    ;;
"open")
    run_cypress "open" "--project" "." "--e2e" "--browser=electron"
    ;;
"desktop")
    # Nothing to do - default flavor - use the config preset's
    OUTPUT="tmp/e2e/$1"
    setup_folders "$OUTPUT"
    run_cypress "run" "--env" "flavor=desktop"
    shift
    ;;
"mobile")
    # Mobile: 360 x 480
    OUTPUT="tmp/e2e/$1"
    setup_folders "$OUTPUT"

    run_cypress "run" \
        "--env" "flavor=mobile" \
        "--config" "videosFolder=../$OUTPUT/videos,screenshotsFolder=../$OUTPUT/screenshots,viewportWidth=360,viewportHeight=640"
    ;;
*)
    echo "Need flavor as [1]" >&2
    exit 255
    ;;
esac
