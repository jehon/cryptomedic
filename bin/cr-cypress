#!/usr/bin/env bash

#
# Arguments:
#   1: desktop / mobile
#
# Folders:
#   OUTPUT: tmp/e2e/$1
#

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

if [[ -z "$1" ]]; then
    echo "Need flavor as [1]" >&2
    exit 255
fi

FLAVOR="$1"
shift

header_begin "Testing cypress for $FLAVOR"
OUTPUT="$CR_TMP"/e2e/"$FLAVOR"
ODOCKER="$(absoluteToDockerRelative "$OUTPUT")"

header_begin "Setup $OUTPUT (into $ODOCKER)"

CYPRESS_ARGS=("--env" "flavor=$FLAVOR")
case "$FLAVOR" in
"desktop")
    # Nothing to do - default flavor - use the config preset's
    ;;
"mobile")
    # Mobile: 360 x 480

    CYPRESS_ARGS+=(
        --config "videosFolder=$ODOCKER/videos,screenshotsFolder=$ODOCKER/screenshots,viewportWidth=360,viewportHeight=640"
        --reporter-options configFile="cypress-reporters-mobile.json"
    )
    ;;
*)
    echo "Unknown flavor: $FLAVOR"
    exit 1
    ;;
esac

cr-ensure-started
cr-fix-permissions "$ODOCKER"

cr-capture-output cr-data-reset
mkdir -p "$OUTPUT"
cr-ensure-folder-empty "$OUTPUT"/screenshots
cr-ensure-folder-empty "$OUTPUT"/videos
cr-ensure-folder-empty "$OUTPUT"/coverage
header_end

header_begin "Cypress run tests (${CYPRESS_ARGS[*]}) ($*)"
time cr-docker-compose run -e CYPRESS_BASE_URL="http://server" --entrypoint=cypress \
    "cypress" \
    run "${CYPRESS_ARGS[@]}" "$@"
header_end

header_begin "Fix permissions"
cr-fix-permissions "$ODOCKER"
header_end
