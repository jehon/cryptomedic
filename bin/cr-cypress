#!/usr/bin/env bash

#
# Arguments:
#   1: desktop / mobile
#
# Folders:
#   OUTPUT: tmp/e2e/$1
#

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

FLAVOR="${1:-desktop}"

header_begin "Testing cypress for $FLAVOR"
OUTPUT="$CR_TMP"/e2e/"$FLAVOR"
ODOCKER="$(absoluteToDockerRelative "$OUTPUT")"

header_begin "Setup $OUTPUT (into $ODOCKER)"
declare -a CYPRESS_ARGS

case "$FLAVOR" in
"desktop")
    # Nothing to do - default flavor - use the config preset's
    ;;
"mobile")
    # Mobile: 360 x 480

    CYPRESS_ARGS=(
        --config "videosFolder=$ODOCKER/videos,screenshotsFolder=$ODOCKER/screenshots,viewportWidth=360,viewportHeight=640"
        --reporter-options configFile="cypress-reporters-mobile.json"
    )
    ;;
*)
    echo "Unknown flavor: $1"
    exit 1
    ;;
esac

CYPRESS_ARGS+=("--env" "config=$FLAVOR")

cr-ensure-started
cr-fix-permissions "$ODOCKER"

cr-capture-output cr-data-reset
mkdir -p "$OUTPUT"
cr-ensure-folder-empty "$OUTPUT"/screenshots
cr-ensure-folder-empty "$OUTPUT"/videos
cr-ensure-folder-empty "$OUTPUT"/coverage
header_end

header_begin "Cypress run tests"
time cr-docker-compose run --rm -e CYPRESS_BASE_URL="http://server:80" --entrypoint=cypress \
    "cypress" \
    run "${CYPRESS_ARGS[@]}" "$@"

cr-fix-permissions "$ODOCKER"
header_end

header_end
