#!/usr/bin/env bash

#
# Arguments:
#   1: desktop / mobile
#
# Folders:
#   OUTPUT: tmp/e2e/$1
#

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

if [[ -z "$1" ]]; then
    echo "Need flavor as [1]" >&2
    exit 255
fi

#
#  See https://stackoverflow.com/questions/50706128/no-version-of-cypress-is-installed-in-ci-travisci-and-circleci
#
# Sometimes, no version of Cypress is installed in: /home/user/.cache/Cypress/9.6.1/Cypress
# Please reinstall Cypress by running: cypress install
#
#
"$(npm root)"/.bin/cypress install

FLAVOR="$1"
shift

echo "* Testing cypress for $FLAVOR"
OUTPUT="$CR_TMP"/e2e/"$FLAVOR"

header_begin "Setup $OUTPUT"

CYPRESS_ARGS=("--env" "flavor=$FLAVOR")
case "$FLAVOR" in
"desktop")
    # Nothing to do - default flavor - use the config preset's
    ;;
"mobile")
    # Mobile: 360 x 480
    CYPRESS_ARGS+=(
        --config "videosFolder=$OUTPUT/videos,screenshotsFolder=$OUTPUT/screenshots,viewportWidth=360,viewportHeight=640"
    )
    ;;
*)
    echo "Unknown flavor: $FLAVOR"
    exit 1
    ;;
esac

mkdir -p "$OUTPUT"
cr-ensure-folder-empty "$OUTPUT"/screenshots
cr-ensure-folder-empty "$OUTPUT"/videos
cr-ensure-folder-empty "$OUTPUT"/coverage
header_end

header_begin "Cypress run tests (${CYPRESS_ARGS[*]}) ($*)"
# $CR_SCRIPT_DIR/node node_modules/.bin/cypress install

# time "$CR_SCRIPT_DIR"/node node_modules/.bin/cypress run "${CYPRESS_ARGS[@]}" "$@"

# docker compose run --rm --quiet-pull -T \
#     --volume "$(pwd):/workdir" \
#     --workdir /workdir \
#     --user "$(id -u)" \
#     cypress
#     run "${CYPRESS_ARGS[@]}" "$@"

"$(npm root)"/.bin/cypress \
    run "${CYPRESS_ARGS[@]}" "$@"

header_end
