#!/usr/bin/bash

set -o errexit
set -o pipefail

. "$(realpath "$(dirname "${BASH_SOURCE[0]}")")"/cr-lib

# We replace the local integration (e2e test results) by those of github

header_begin "Getting latest ended run"
# https://cli.github.com/manual/gh_run_list
# gh run list --branch main --limit 1 --workflow .github/workflows/test.yml
RUN_ID="$(gh run list --status completed --branch main --limit 1 --workflow .github/workflows/test.yml --json databaseId --jq ".[0].databaseId")"
PAGER="" gh run view "$RUN_ID"
echo "RUN_ID: $RUN_ID"
header_end

get_artifact() {
    artifactName="$1"
    destination="$2"
    echo "* getting ${artifactName}"
    echo "    -> ${destination}"

    (
        rm -fr "${destination}"
        mkdir -p "${destination}"
        gh run download "$RUN_ID" --name "${artifactName}" --dir "${destination}"
    )
}

header_begin "Copying files locally"
get_artifact "integration-desktop" "$CR_TMP/integration/desktop"
get_artifact "integration-mobile" "$CR_TMP/integration/mobile"
get_artifact "integration-playwright" "$CR_TMP/integration/playwright"
get_artifact "integration-playwright-update" "$CR_TMP/integration/playwright-update"
header_end

header_begin "Reintegrate playwright references"
rsync --itemize-changes --recursive \
    --omit-dir-times \
    --checksum \
    "$CR_TMP/integration/playwright-update/" "tests/e2e/"
header_end

echo "Done with success"
