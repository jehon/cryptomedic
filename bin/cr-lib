#!/usr/bin/env bash

set -o errexit

export CR_SCRIPT_DIR
export CR_PRJ_DIR
export CR_TMP
export CR_DB_ROOT_PASS="password"
export CR_DB_NAME="cryptomedic"
# From docker-compose.yml
export CR_DB_USER_PASS="password"
export CR_DB_ROOT_PASS="password"
export CR_DB_USER="username"

export CR_HTTP_PORT="${CRYPTOMEDIC_PORT:-5080}"
export CR_HTTP_HOST="${CRYPTOMEDIC_HTTP_HOST:-"localhost"}:$CR_HTTP_PORT"

CR_SCRIPT_DIR="$(realpath "$(dirname "${BASH_SOURCE[0]}")")"
CR_PRJ_DIR="$(dirname "$CR_SCRIPT_DIR")"
CR_TMP="$CR_PRJ_DIR/tmp"

export PATH="$CR_SCRIPT_DIR:$PATH"

# For recursion
export CR_HEADER_PREFIX="*$CR_HEADER_PREFIX"

if [ -n "$JH_PACKAGE_FOLDER" ]; then
    # shellcheck source=/dev/null
    . "$JH_PACKAGE_FOLDER"/bin/jh-secrets-get "CRYPTOMEDIC_UPLOAD_USER" "CRYPTOMEDIC_UPLOAD_PASSWORD" "CRYPTOMEDIC_DB_UPGRADE"
fi

header() {
    LASTMSG="$*"
    echo -e "\e[93m$CR_HEADER_PREFIX $*\e[00m"
}

header_finished() {
    echo -e "\e[93m$CR_HEADER_PREFIX $LASTMSG done\e[00m"
}

# 1: absolute path
# 2: docker path
p2docker() {
    # Thanks to https://stackoverflow.com/a/28523143/1954789
    echo "${2:-/app}/$(realpath --canonicalize-missing --relative-to="$CR_PRJ_DIR" "$1")"
}
