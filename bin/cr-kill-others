#!/usr/bin/env bash

set -o errexit
set -o pipefail

# TODO

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

DEV="$(docker ps --filter status=running --filter publish="$CR_HTTP_PORT" --format="{{.Names}}")"

if [ -z "$DEV" ]; then
    echo "Nobody is publishing on $CR_HTTP_PORT"
    exit 0
fi
echo "Found dev server: $DEV"

ROOT="${DEV/_*/}"
echo "Found root: $ROOT"

docker ps --filter name="${ROOT}_[a-z]+_1" --format="{{.Names}}" | while read -r CI; do
    echo "Killing $CI..."
    docker stop "$CI"
    echo "Killing $CI done"
done
