#!/usr/bin/env bash

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

cr-ensure-started

if [ -z "$CRYPTOMEDIC_DB_UPGRADE" ]; then
    echo "Initialize CRYPTOMEDIC_DB_UPGRADE"
    CRYPTOMEDIC_DB_UPGRADE="secret"
fi

echo "Deploying to ${CR_HTTP_HOST} with pwd of #${#CRYPTOMEDIC_DB_UPGRADE} char length"

header_begin "* Upgrading database"
curl -fsSL "http://${CR_HTTP_HOST}/maintenance/patch_db.php?pwd=${CRYPTOMEDIC_DB_UPGRADE}"
header_end

header_begin "* Upgrading files"
curl -fsSL "http://${CR_HTTP_HOST}/maintenance/reset.php?pwd=${CRYPTOMEDIC_DB_UPGRADE}"
header_end

for E in "$CR_PRJ_DIR"/www/api/*/bin/refresh.sh; do
    if [ ! -f "$E" ]; then
        continue
    fi
    header_begin "cr-refresh-structure found: $E..."
    "$E"
    header_end
done
