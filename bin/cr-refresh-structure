#!/usr/bin/env bash

set -o errexit
set -o pipefail

# shellcheck source=./cr-lib
. "$(dirname "${BASH_SOURCE[0]}")"/cr-lib

if [ -z "$CRYPTOMEDIC_DB_UPGRADE" ]; then
    echo "Initialize CRYPTOMEDIC_DB_UPGRADE"
    CRYPTOMEDIC_DB_UPGRADE="secret"
fi

echo "Deploying to ${CR_HTTP_HOST} with pwd of #${#CRYPTOMEDIC_DB_UPGRADE} char length"

header_begin "Upgrading database"
cr_curl "http://${CR_HTTP_HOST}/maintenance/patch_db.php?pwd=${CRYPTOMEDIC_DB_UPGRADE}"
header_end

header_begin "Upgrading files"
cr_curl "http://${CR_HTTP_HOST}/maintenance/reset.php?pwd=${CRYPTOMEDIC_DB_UPGRADE}"
header_end
