#!/usr/bin/env bash

set -o errexit

CR_SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"

# shellcheck source=./cr-lib
. "$CR_SCRIPT_DIR"/cr-lib

cr-ensure-started

if [ -z "$CRYPTOMEDIC_DB_UPGRADE" ]; then
    echo "* Initialize CRYPTOMEDIC_DB_UPGRADE"
    CRYPTOMEDIC_DB_UPGRADE="$(cr-get-config "security.key")"
fi

echo "Deploying to ${CR_HTTP_HOST} with pwd of #${#CRYPTOMEDIC_DB_UPGRADE} char length"

echo "* Upgrading database"
curl -fsSL "http://${CR_HTTP_HOST}/maintenance/patch_db.php?pwd=${CRYPTOMEDIC_DB_UPGRADE}"

echo "* Upgrading files"
curl -fsSL "http://${CR_HTTP_HOST}/maintenance/reset.php?pwd=${CRYPTOMEDIC_DB_UPGRADE}"

for E in "$CR_PRJ_DIR"/www/api/*/bin/refresh.sh; do
    if [ ! -f "$E" ]; then
        continue
    fi
    echo "cr-refresh-structure found: $E..."
    "$E"
    echo "cr-refresh-structure found: $E done"
done
